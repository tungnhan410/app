<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Qu·∫£n l√Ω c√¥ng n·ª£ n√¢ng cao</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script> 
  <style> 
    body { font-family: Arial; background: #f4f4f4; padding: 20px; } 
    .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
    input, select, button { padding: 6px 10px; margin: 5px 0; border-radius: 4px; border: 1px solid #ccc; }
    .btn { background: #2c7be5; color: white; border: none; cursor: pointer; }
    .btn:hover { background: #1a5edc; }
    .btn-danger { background: #dc3545; }
    .btn-warning { background: #ffc107; color: black; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    th { background: #f0f0f0; }
  </style>
</head>
<body>


  <div id="loginCard" class="card">
  <h2>ƒêƒÉng nh·∫≠p / ƒêƒÉng k√Ω</h2>
  <label>T√†i kho·∫£n: <input type="text" id="loginUser"></label><br>
  <label>M·∫≠t kh·∫©u: <input type="password" id="loginPass"></label><br>
  <button class="btn" onclick="dangNhap()">ƒêƒÉng nh·∫≠p</button>
  <button class="btn-warning" onclick="dangKy()">ƒêƒÉng k√Ω</button>
  
</div>

<div id="mainContent">
  <div id="userPanel">
    üëã Xin ch√†o, <span id="tenUser"></span>
    <button class="btn-danger" onclick="dangXuat()">ƒêƒÉng xu·∫•t</button>
  </div>

<div class="card">
  <h2>Nh·∫≠p giao d·ªãch</h2>
  <label>M√£ KH: <input type="text" id="maKH" list="danhSachMa" oninput="layTenTuMa()"></label>
  <datalist id="danhSachMa"></datalist><br>
  <label>T√™n KH: <input type="text" id="ten" list="danhSachTen"></label>
  <datalist id="danhSachTen"></datalist><br>
  <label>Ng√†y: <input type="date" id="ngay"></label><br>
  <label>Lo·∫°i: 
    <select id="loai">
      <option value="Ghi N·ª£">Ghi N·ª£</option>
      <option value="Tr·∫£ N·ª£">Tr·∫£ N·ª£</option>
    </select>
  </label><br>
  <label>M√£ h√†ng h√≥a: <input type="text" id="mahang" list="danhSachMaHang" oninput="layTenTuMaHang()"></label>
  <datalist id="danhSachMaHang"></datalist><br>
  <label>T√™n h√†ng h√≥a: <input type="text" id="tenhang"></label><br>
  <label>S·ªë l∆∞·ª£ng: <input type="number" id="soluong" oninput="capNhatThanhTien()"></label><br>
  <label>ƒê∆°n gi√°: <input type="number" id="dongia" oninput="capNhatThanhTien()"></label><br>
  <label>Th√†nh ti·ªÅn: <input type="number" id="thanhtien" readonly></label>
  <label>S·ªë d∆∞ ƒë·∫ßu k·ª≥: <input type="number" id="sodu"></label>
<button onclick="luuSoDuDauKy()">L∆∞u ƒë·∫ßu k·ª≥</button>
  <button class="btn" onclick="nhapGiaoDich()">Nh·∫≠p</button>
  <button class="btn" onclick="xuatExcel()">Xu·∫•t Excel</button>
  <button class="btn" onclick="inBaoCao()">In b√°o c√°o</button>
</div>




<div class="card">
  <h2>Chi ti·∫øt giao d·ªãch</h2>
  <table>
    <thead>
      <tr>
        <th>STT</th><th>Ng√†y</th><th>M√£ KH</th><th>T√™n</th><th>Lo·∫°i</th><th>M√£ h√†ng</th><th>T√™n h√†ng</th><th>SL</th><th>ƒê∆°n gi√°</th><th>Th√†nh ti·ªÅn</th><th>H√†nh ƒë·ªông</th>
      </tr>
    </thead>
    <tbody id="bangChiTiet"></tbody>
  </table>
</div>

<div class="card">
  <h2>T·ªïng h·ª£p c√¥ng n·ª£</h2>
  <table>
    <thead>
      <tr><th>T√™n</th><th>N·ª£ ƒë·∫ßu k·ª≥</th><th>Ghi n·ª£</th><th>Tr·∫£ n·ª£</th><th>N·ª£ hi·ªán t·∫°i</th></tr>
    </thead>
    <tbody id="bangTongHop"></tbody>
  </table>
</div>



<script>
let maTenMap = JSON.parse(localStorage.getItem("ma_ten_map") || '{}');
let maHangMap = JSON.parse(localStorage.getItem("ma_hang_map") || '{}');
let giaoDichList = JSON.parse(localStorage.getItem("congno") || "[]");
let editingIndex = -1;
let users = JSON.parse(localStorage.getItem("users") || "{}");
// T·ª± ƒë·ªông ƒëi·ªÅn m·∫≠t kh·∫©u khi nh·∫≠p t√†i kho·∫£n
document.getElementById("loginUser").addEventListener("input", function () {
  const u = this.value.trim();
  if (users[u]) {
    document.getElementById("loginPass").value = users[u];
  } else {
    document.getElementById("loginPass").value = "";
  }
});

let currentUser = localStorage.getItem("currentUser") || "";
let soduDauKy = JSON.parse(localStorage.getItem("sodu_dauky") || "{}");

function layTenTuMa() {
  const ma = document.getElementById("maKH").value.trim();
  if (maTenMap[ma]) document.getElementById("ten").value = maTenMap[ma];
  if (soduDauKy[ma]) document.getElementById("sodu").value = soduDauKy[ma];
}

function luuSoDuDauKy() {
  const ma = document.getElementById("maKH").value.trim();
  const sodu = parseFloat(document.getElementById("sodu").value);
  if (!ma || isNaN(sodu)) return alert("Vui l√≤ng nh·∫≠p m√£ KH v√† s·ªë d∆∞!");
  soduDauKy[ma] = sodu;
  localStorage.setItem("sodu_dauky", JSON.stringify(soduDauKy));
  alert("ƒê√£ l∆∞u s·ªë d∆∞ ƒë·∫ßu k·ª≥.");
}




function dangNhap() {
  const u = document.getElementById("loginUser").value.trim();
  const p = document.getElementById("loginPass").value;
  if (!u || !p) return alert("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!");
  if (!users[u] || users[u] !== p) return alert("Sai t√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u");
  localStorage.setItem("currentUser", u);
  location.reload();
}

function dangKy() {
  const u = document.getElementById("loginUser").value.trim();
  const p = document.getElementById("loginPass").value;
  if (!u || !p) return alert("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!");
  if (users[u]) return alert("T√†i kho·∫£n ƒë√£ t·ªìn t·∫°i!");
  users[u] = p;
  localStorage.setItem("users", JSON.stringify(users));
  localStorage.setItem("currentUser", u);
  location.reload();
}

function dangXuat() {
  localStorage.removeItem("currentUser");
  location.reload();
}

window.onload = () => {
  if (!currentUser) {
    document.getElementById("loginCard").style.display = "block";
    document.getElementById("mainContent").style.display = "none";
  } else {
    document.getElementById("loginCard").style.display = "none";
    document.getElementById("mainContent").style.display = "block";
    document.getElementById("tenUser").innerText = currentUser;
  }
};

function layTenTuMaHang() {
  const ma = document.getElementById("mahang").value.trim();
  if (maHangMap[ma]) {
    document.getElementById("tenhang").value = maHangMap[ma];

  }
}
function capNhatThanhTien() {
  const sl = parseFloat(document.getElementById("soluong").value) || 0;
  const dg = parseFloat(document.getElementById("dongia").value) || 0;
  document.getElementById("thanhtien").value = (sl * dg).toFixed(0);
}
function nhapGiaoDich() {
  const maKH = document.getElementById("maKH").value.trim();
  const ten = document.getElementById("ten").value.trim();
  const ngay = document.getElementById("ngay").value;
  const loai = document.getElementById("loai").value;
  const mahang = document.getElementById("mahang").value.trim();
  const tenhang = document.getElementById("tenhang").value.trim();
  const soluong = parseFloat(document.getElementById("soluong").value);
  const dongia = parseFloat(document.getElementById("dongia").value);
  const thanhtien = parseFloat(document.getElementById("thanhtien").value);
  if (!maKH || !ten || !ngay || !tenhang || isNaN(soluong) || isNaN(dongia) || isNaN(thanhtien)) {
    alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
    return;
  }
  maTenMap[maKH] = ten;
  maHangMap[mahang] = tenhang;
  localStorage.setItem("ma_ten_map", JSON.stringify(maTenMap));
  localStorage.setItem("ma_hang_map", JSON.stringify(maHangMap));
  const data = { maKH, ten, ngay, loai, mahang, tenhang, soluong, dongia, thanhtien };
  if (editingIndex >= 0) {
    giaoDichList[editingIndex] = data;
    editingIndex = -1;
  } else {
    giaoDichList.push(data);
  }
  localStorage.setItem("congno", JSON.stringify(giaoDichList));
  resetForm();
  capNhatBang();
}
function resetForm() {
  ["maKH", "ten", "ngay", "mahang", "tenhang", "soluong", "dongia", "thanhtien"].forEach(id => document.getElementById(id).value = "");
  editingIndex = -1;
}
function capNhatBang() {
  const tbody = document.getElementById("bangChiTiet");
  const tongHopBody = document.getElementById("bangTongHop");
  tbody.innerHTML = "";
  tongHopBody.innerHTML = "";
  const tongHop = {};
  const noDauKy = {};
  const today = new Date().toISOString().split("T")[0];
  giaoDichList.forEach((g, i) => {
    if (!tongHop[g.ten]) tongHop[g.ten] = { ghi: 0, tra: 0 };
    if (!noDauKy[g.ten]) noDauKy[g.ten] = 0;
    if (g.ngay < today) {
      noDauKy[g.ten] += (g.loai === "Ghi N·ª£" ? g.thanhtien : -g.thanhtien);
    } else {
      if (g.loai === "Ghi N·ª£") tongHop[g.ten].ghi += g.thanhtien;
      else tongHop[g.ten].tra += g.thanhtien;
    }
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i + 1}</td>
      <td>${g.ngay}</td>
      <td>${g.maKH}</td>
      <td>${g.ten}</td>
      <td>${g.loai}</td>
      <td>${g.mahang}</td>
      <td>${g.tenhang}</td>
      <td>${g.soluong}</td>
      <td>${g.dongia}</td>
      <td>${g.thanhtien.toLocaleString()}</td>
      <td>
        <button class="btn-warning" onclick="suaGiaoDich(${i})">S·ª≠a</button>
        <button class="btn-danger" onclick="xoaGiaoDich(${i})">X√≥a</button>
      </td>`;
    tbody.appendChild(tr);
  });
  for (const ten in tongHop) {
    const g = tongHop[ten];
    const dauky = noDauKy[ten] || 0;
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${ten}</td><td>${dauky}</td><td>${g.ghi}</td><td>${g.tra}</td><td>${dauky + g.ghi - g.tra}</td>`;
    tongHopBody.appendChild(tr);
  }
}
function suaGiaoDich(index) {
  const g = giaoDichList[index];
  document.getElementById("maKH").value = g.maKH;
  document.getElementById("ten").value = g.ten;
  document.getElementById("ngay").value = g.ngay;
  document.getElementById("loai").value = g.loai;
  document.getElementById("mahang").value = g.mahang;
  document.getElementById("tenhang").value = g.tenhang;
  document.getElementById("soluong").value = g.soluong;
  document.getElementById("dongia").value = g.dongia;
  document.getElementById("thanhtien").value = g.thanhtien;
  editingIndex = index;
}
function xoaGiaoDich(i) {
  if (confirm("X√≥a d√≤ng n√†y?")) {
    giaoDichList.splice(i, 1);
    localStorage.setItem("congno", JSON.stringify(giaoDichList));
    capNhatBang();
  }
}
function xuatExcel() {
  const wb = XLSX.utils.book_new();
  const data = [["Ng√†y", "M√£ KH", "T√™n", "Lo·∫°i", "M√£ h√†ng", "T√™n h√†ng", "SL", "ƒê∆°n gi√°", "Th√†nh ti·ªÅn"]];
  giaoDichList.forEach(g => data.push([g.ngay, g.maKH, g.ten, g.loai, g.mahang, g.tenhang, g.soluong, g.dongia, g.thanhtien]));
  const ws = XLSX.utils.aoa_to_sheet(data);
  XLSX.utils.book_append_sheet(wb, ws, "GiaoDich");
  XLSX.writeFile(wb, "cong_no.xlsx");
}
function inBaoCao() {
  window.print();
}
window.onload = () => {
  capNhatBang();
  const dsMa = document.getElementById("danhSachMa");
  const dsTen = document.getElementById("danhSachTen");
  const dsMaHang = document.getElementById("danhSachMaHang");
  dsMa.innerHTML = "";
  dsTen.innerHTML = "";
  dsMaHang.innerHTML = "";
  for (const ma in maTenMap) {
    const opt = document.createElement("option");
    opt.value = ma;
    dsMa.appendChild(opt);
    const optTen = document.createElement("option");
    optTen.value = maTenMap[ma];
    dsTen.appendChild(optTen);
  }
  for (const ma in maHangMap) {
    const opt = document.createElement("option");
    opt.value = ma;
    dsMaHang.appendChild(opt);
  }
};
window.onload = () => {
  if (!currentUser) {
    document.getElementById("loginCard").style.display = "block";
    document.getElementById("mainContent").style.display = "none";
  } else {
    document.getElementById("loginCard").style.display = "none";
    document.getElementById("mainContent").style.display = "block";
    document.getElementById("tenUser").innerText = currentUser;
  }
};
</script>

</body>
</html>
